# 系统基础软件环境
- include_tasks: centos.yml
  when: ansible_distribution == "CentOS" or ansible_distribution == "RedHat"

- import_tasks: debian.yml
  when: ansible_distribution == "Ubuntu" or ansible_distribution == "Debian"

# 公共系统参数设置
- import_tasks: common.yml


- name: prepare some dirs
  file: name={{ item }} state=directory
  with_items:
  - "{{ bin_dir }}"
  - "{{ ca_dir }}"
  - /root/.kube
  - /etc/docker
  - /var/log/kube

#- name: 集群hosts文件更新
#  copy: src=hosts.j2 dest=/etc/hosts

- name: 写入环境变量$PATH
  lineinfile:
    dest: /etc/profile
    state: present
    regexp: 'kube-bin'
    line: 'export PATH={{ bin_dir }}:$PATH # generated by kube-bin'


- name: 本地设置 bin 目录权限
  file: path={{ base_dir }}/bin state=directory mode=0755 recurse=yes
  connection: local
  run_once: true

#- name: 写入环境变量$PATH
#  shell: "sed -i '/export PATH=/d' /etc/profile && \
#	echo export PATH={{ bin_dir }}:$PATH >> /etc/profile"

- name: 分发证书工具 CFSSL
  copy: src={{ base_dir }}/bin/{{ item }} dest={{ bin_dir }}/{{ item }} mode=0755
  with_items:
  - cfssl
  - cfssl-certinfo
  - cfssljson

- name: 分发CA 证书
  copy: src={{ base_dir }}/roles/prepare/files/{{ item }} dest={{ ca_dir }}/{{ item }} mode=0644
  with_items:
  - ca.pem
  - ca-key.pem
  - ca.csr
  - ca-config.json

# 先拉取下节点的ansible setup信息，起到缓存效果，否则后续when 判断可能失败
#- name: 缓存ansilbe setup信息
#  setup: gather_subset=min


#- name: 关闭 selinux
#  shell: "setenforce 0 && echo SELINUX=disabled > /etc/selinux/config"
#  shell: "setenforce 0  ; echo SELINUX=disabled > /etc/selinux/config "
#  when: ansible_distribution == "CentOS"
#  ignore_errors: true



# 设置系统参数for k8s
# 消除docker info 警告WARNING: bridge-nf-call-ip[6]tables is disabled
#- name: 设置系统参数
#  copy: src=95-k8s-sysctl.conf dest=/etc/sysctl.d/95-k8s-sysctl.conf
#
#- name: 生效系统参数
#  shell: "  modprobe br_netfilter  &&  sysctl -p /etc/sysctl.d/95-k8s-sysctl.conf"
#  ignore_errors: true
